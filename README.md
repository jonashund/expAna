# expAna

Process raw DIC images or evaluation data exported from Istra4D to gain true stress strain curves.

## Requirements

-   Python (Version 3.x, e.g. via [pyenv](https://github.com/pyenv/pyenv) or [Conda](https://docs.conda.io/en/latest/))

    -   creating and subsequently setting/activating an environment is recommended

    #### **TLDR**: [Managing environments with Conda](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html)

    -   create an environment based on version X.X of Python and packages 1,2 and three:\
        `conda create --name <my_env_name> python=X.X package1 package2`
    -   **remark:** Python and packages are optional\
        `conda create --name <my_env_name>`
    -   activate environment:\
        `conda activate <my_env_name>`
    -   deactivate environment:\
        `conda deactivate`
    -   remove an environment:\
        `conda remove --name <my_env_name> --all`

## Installation

### Create the environment

**1. manually using conda and pip (tested on CentOS):** 

-   based on current Python version with ipython and numpy:\
    `conda create --name <my_env_name> ipython numpy`
-   activate created environment:\
    `conda activate <my_env_name>`
-   install scipy v1.2.1 (requirement of muDIC_ifm):\
    `pip install scipy==1.2.1`

**2. using conda and environmental.yml (tested on CentOS):**

-   execute in directory with `environmental.yml` (after cloning [`expDoc`](https://git.scc.kit.edu/ifm/labor/exputil/expDoc) or [`expAna`](https://git.scc.kit.edu/ifm/labor/exputil/expAna) )\
    `conda env create -f environmental.yml`

**3. using pyenv virtualenv (on macOS):**

-   install `pyenv virtualenv` via homebrew
-   install `miniconda-latest`:\
    `pyenv install miniconda-latest`
-   create a new virtualenv based on `miniconda-latest`:\
    `pyenv virtualenv miniconda-latest <my_env_name>`
-   in a directory (with one of the packages below) set the local environment:\
    `pyenv local <my_env_name>`
-   downgrade to Python v3.7 in the environment:\
    `conda install python=3.7`
-   install scipy v1.2.1 (requirement of muDIC_ifm):\
    `conda install scipy=1.2.1`
-   install ipython:\
    `conda install ipython`
-   install packages listed below, the local environment has to be set in each directory unless it's made the global environment (temporarily)

**4. manually using conda (on macOS):**

-   create environment:
    `conda create --name <my_env_name> python=3.7 scipy=1.2.1 numpy ipython`

### Cloning the repositories and installing

Clone from [gitlab](https://git.scc.kit.edu/) into a local repository and install in the following order from within the corresponding repository:

1.  [`istra2py`](https://git.scc.kit.edu/ifm/labor/istra2py)
    -   `git clone git@git.scc.kit.edu:ifm/labor/istra2py.git`
    -   `cd ./istra2py`
    -   `pip install -e .`
2.  [`muDIC_ifm`](https://git.scc.kit.edu/ifm/labor/exputil/mudic_ifm)
    -   `git clone git@git.scc.kit.edu:ifm/labor/exputil/mudic_ifm.git`
    -   `cd ./muDIC_ifm`
    -   `pip install -e .`
3.  [`expDoc`](https://git.scc.kit.edu/ifm/labor/exputil/expDoc):
    -   `git clone git@git.scc.kit.edu:ifm/labor/exputil/expDoc.git`
    -   `cd ./expDoc`
    -   `pip install -e .`
4.  [`expAna`](https://git.scc.kit.edu/ifm/labor/exputil/expAna):
    -   `git clone git@git.scc.kit.edu:ifm/labor/exputil/expAna.git`
    -   `cd ./expAna`
    -   `pip install -e .`

## Usage

### Folder structure:

-   `project_directory`
    -   `data_expDoc` _created by expDoc_
    -   `data_instron` _instron project directory_
        -   `Test1`
        -   `Test2`
    -   `data_istra_acquisition` _Istra4D acquisition directories_
        -   `Test1`
        -   `Test2`
    -   `data_istra_evaluation` _Istra4D evaluation directories_
        -   `Test1CORN1`
        -   `Test2CORN1`
    -   `data_export2tif` _generated by acquis2tif_
        -   `Test1`
        -   `Test2`
    -   `data_muDIC` _generated by dic_with_muDIC_
        -   `Test1`
        -   `Test2`
    -   `visualisation` _generated by vis scripts_
        -   `istra` _generated by vis_basic_stress_
        -   `muDIC` _generated by vis_basic_stress with dic="muDIC"_

### Data acquisition

-   record experiments with the [_LIMESS Q-400_](https://git.scc.kit.edu/ifm/labor/pruefmaschinen/-/tree/master/DIC_Limess) system
    -   name the recorded files similarly as the _Instron WaveMatrix_ software
-   optional: evaluate the acquisitions 

### Data import

-   from the laboratory laptop running _Istra4D_ transfer the respective data into the `data_istra_<foo>` directories

### Obtaining true stress strain curves

-   in the `project_directory` open a terminal
-   run (preferably) `ipython` or `python`
-   `import expAna`
-   for every function called below look into the code or call as script to gain insight into optional arguments
    #### Option 1: Use evaluated data from _Istra4D_
-   `expAna.eval2stress.main()`
-   experiments to consider can be selected via `experiment_list=["TestN","TestM","TestX"]` or through a selection criterion based on a key value pair passed on as a list via `select=[<key>, <value>]`
    -    the key value pair provided must be part of the `documentation_data` dictionary that is created for every experiment by running `expDoc` and subsequently used by `expAna`
    -   this dictionary is an attribute of every instance of the `Experiment` class and contains all the information for each experiment that is provided through the project's _Excel_ spreadsheet
-   in the same manner a list of experiment to be ignored can be specified and passed on via `ignore_list=["TestY"."TestZ"]`
    #### Option 2: Use `muDIC` on _Istra4D_ acquisition data
-   read an convert images: `expAna.acquis2tif.main()`
-   digital image correlation with `muDIC`: `expAna.dic_with_muDIC.main()`
-   true stress strain behaviour from DIC results: `expAna.muDIC2stress.main()`
-   TO DO: expand the `muDIC` part of the analysis functions to also accept `experiment_list`, `ignore_list` and `select` parameters

### Basic visualisation

-   plot stress strain curves: `expAna.vis.basic.stress()`
-   plot force displacement curves: `expAna.vis.basic.force()`
-   pass on `set_failure=True` to remove corrupted parts of the stress strain curves via a GUI
-   experiments to consider can be selected via `experiment_list=["TestN","TestM","TestX"]` or through a selection criterion based on a `documentation_data` dictionary key value pair passed on as a list via `select=[<key>, <value>]`

### DIC visualisation

-   from experiments with _Istra4D_ evaluation files available plots with DIC strain field can be produced with the function   

  `expAna.vis.plot.dic_strains(experiment_name="TestX", displacement=1,strain_component="x")`
-   mandatory parameters:
    -   `experiment_name` (string): name of the folder with results omitting "CORN1" at its end
    -   `displacement` (float): traverse displacement where the results should be visualised in mm
    -   `strain_component` (string): possible values are "x", "y" an "xy" describing the strain relative to the tensile direction (given in image coordinate system) such that "x" means in tensile direction
- optional parameters:
    -   `tensile_direction` (string): "x" or "y"; tensile direction in terms of image coordinate system (x: horizontal, y: vertical); if not specified GUI to enter direction via arrow key opens
    -   'key' (bool): `True`(default) or `False`; colorbar or no colorbar right to plot of image
    -   'key_min' (float): minimum value for colorbar, default: `None`
    -   'key_max' (float): maximum value for colorbar, default: `None`
    -   `key_extend` (string): "min", "max", "both", "neither", default: `None`
    -   `max_triang_len` (integer): threshold of triangle length to be included in plot of Delaunay triangulation, default: 10
    -   `out_format` (string): "eps" (default) or "pgf"

    #### Examples:
    
    -   **example # 0:** `expAna.vis.plot.dic_strains(experiment_name="Test3", strain_component="x", tensile_direction="x", displacement=2.2, max_triang_len=25, key_min=0, key_max=0.5, key_extend="neither")`
    -   **example # 1:** `expAna.vis.plot.dic_strains(experiment_name="Test3", strain_component="x", tensile_direction="x", displacement=1.5, no_key=True)`

    #### Issues:
    
    -   `key = False` option only works when at least one previous command with `key = True` was executed
 
### Results analysis

-   experiments may be selected using a `<key>`,`<value>` pair passed on as a list via `select=[<key>, <value> ]`
-   a non-optional input parameter for every analysis is `compare=<key>` where another `<key>` from the `documentation_data` dictionary must be passed on that is then used to compare the selected experiments
-   **remark**: by default at least three experiments matching each criterion are required by the script

    #### Examples:

    -   **example # 0:** calculate and visualise the mean behaviour for every `<value>` found for the provided `<key>` and also visualise the mean curves in a comparison plot: `expAna.vis.analysis.stress(compare="<key")` or `expAna.vis.analysis.force(compare="<key")`
    -   **example # 1:** compare the experiments of the project regarding the different values for the key "specimen_orientation": `expAna.vis.analysis.stress(compare="specimen_orientation")`
    -   **example # 2:** select all experiments that were carried out at a "crosshead_speed" of 0.1 and compare them regarding "specimen_orientation"

## TO DO:

-   add version number of _Istra4D_
-   add commands via console_script
-   add test data and tests
